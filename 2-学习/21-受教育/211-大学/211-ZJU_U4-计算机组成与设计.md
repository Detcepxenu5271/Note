# ZJU计算机组成与设计


## 一、概论
### 性能参数
CPU时钟周期，CPI（指令执行所需的时钟周期）

CISC（复杂指令集计算机）  
RISC（精简指令集计算机）
* 指令数量少，功能单一，寻址方式简单，长度固定，执行时间固定

软件运行方式
1. 解释执行
2. 编译执行

## 二、编码
### $2.01 引言
常用基本数据类型
* 整数
* 字符
* 汉字
* 浮点数

### $2.02 ASCII与汉字
### $2.03 数的进制与转换
进位计数制：有限符号（基数）表示无限数值

标准ASCII码为7位编码，扩展ASCII为8位（扩充字符高位为1）

手动十进制转二进制：建议先转十六进制（熟悉十六进制）

校验码：
* 分为：检错码，纠错码。（检错码只能报告有错误）
* 检错码包括奇偶检验码（代价小，容易实现）等
* 纠错码包括循环码等

### $2.04 逻辑运算
32位移位器的好实现：

![Shift32b](../../../img/2022-04-11_00-39-35_32位移位器.png)

### $2.05 ！整数表示
| 码制 | 原码                           | 补码      | 移码      |
| ---- | ------------------------------ | --------- | --------- |
| 最小 | 1111 1111                      | 1000 0000 | 1000 0000 |
| -1   | 1000 0001                      | 1111 1111 | 0111 1111 |
| 0    | 1000 0000(-0)<br>0000 0000(+0) | 0000 0000 | 1000 0000 |
| 1    | 0000 0001                      | 0000 0001 | 1000 0001 |
| 最大 | 0111 1111                      | 0111 1111 | 1111 1111 |

![三种码制比较](../../../img/2022-04-11_00-45-54_二进制数码表示.png)

#### 原码


#### 移码
#### 补码
### $2.06 加法与减法
加法器基本公式：
* 本位和：S=A^B^C
* 进位：C=AB+BC+CA

## 三、加法器，乘法器
## 四、除法器，浮点数
## 五、指令
### 内容
MIPS指令基本格式
* 长度为32位
* 高6位为操作码，其余为操作数

MIPS指令类别
1. R-Type
	| 31-26  | 25-21 | 20-16 | 15-11 |  10-6   |  5-0   |
	| :----: | :---: | :---: | :---: | :-----: | :----: |
	| 000000 | rs:5  | rt:5  | rd:5  | shamt:5 | Func:6 |
	- 基本参数说明
		+ 操作码固定为000000，由Func决定功能
		+ rs，rt，rd是寄存器
		+ shamt是位移（shift amount）
	- 具体指令
		| 指令    | 参数       | Func   |
		| :------ | :--------- | :----- |
		| add     | rd, rs, rt | 100000 |
		| addu    | rd, rs, rt | 100001 |
		| and     | rd, rs, rt | 100100 |
		| break   |            | 001101 |
		| div     | rs, rt     | 011010 |
		| divu    | rs, rt     | 011011 |
		| jalr    | rd, rs     | 001001 |
		| jr      | rs         | 001000 |
		| mfhi    | rd         | 010000 |
		| mflo    | rd         | 010010 |
		| mthi    | rs         | 010001 |
		| mtlo    | rs         | 010011 |
		| mult    | rs, rt     | 011000 |
		| multu   | rs, rt     | 011001 |
		| nor     | rd, rs, rt | 100111 |
		| or      | rd, rs, rt | 100101 |
		| sll     | rd, rt, sa | 000000 |
		| sllv    | rd, rt, rs | 000100 |
		| slt     | rd, rs, rt | 101010 |
		| sltu    | rd, rs, rt | 101011 |
		| sra     | rd, rt, sa | 000011 |
		| srav    | rd, rt, rs | 000111 |
		| srl     | rd, rt, sa | 000010 |
		| srlv    | rd, rt, rs | 000110 |
		| sub     | rd, rs, rt | 100010 |
		| subu    | rd, rs, rt | 100011 |
		| syscall |            | 001100 |
		| xor     | rd, rs, rt | 100110 |
2. I-Type
	| 31-26 | 25-21 | 20-16 |     15-0     |
	| :---: | :---: | :---: | :----------: |
	| OP:6  | rs:5  | rt:5  | immediate:16 |
	- 基本参数说明
		+ rs，rt是寄存器
		+ immediate是立即数
	- 具体指令
		| 指令  | 参数              | Opcode            |
		| :---- | :---------------- | :---------------- |
		| addi  | rt, rs, immediate | 001000            |
		| addiu | rt, rs, immediate | 001001            |
		| andi  | rt, rs, immediate | 001100            |
		| beq   | rs, rt, label     | 000100            |
		| bgez  | rs, label         | 000001 rt = 00001 |
		| bgtz  | rs, label         | 000111 rt = 00000 |
		| blez  | rs, label         | 000110 rt = 00000 |
		| bltz  | rs, label         | 000001 rt = 00000 |
		| bne   | rs, rt, label     | 000101            |
		| lb    | rt, immediate(rs) | 100000            |
		| lbu   | rt, immediate(rs) | 100100            |
		| lh    | rt, immediate(rs) | 100001            |
		| lhu   | rt, immediate(rs) | 100101            |
		| lui   | rt, immediate     | 001111            |
		| lw    | rt, immediate(rs) | 100011            |
		| lwc1  | rt, immediate(rs) | 110001            |
		| ori   | rt, rs, immediate | 001101            |
		| sb    | rt, immediate(rs) | 101000            |
		| slti  | rt, rs, immediate | 001010            |
		| sltiu | rt, rs, immediate | 001011            |
		| sh    | rt, immediate(rs) | 101001            |
		| sw    | rt, immediate(rs) | 101011            |
		| swc1  | rt, immediate(rs) | 111001            |
		| xori  | rt, rs, immediate | 001110            |
3. J-Type
	| 31-26  |   25-0    |
	| :----: | :-------: |
	| 00001x | target:26 |
	- 基本参数说明
		+ target是
	- 具体指令
		| 指令 | 参数  | Opcode |
		| :--- | :---- | :----- |
		| j    | label | 000010 |
		| jal  | label | 000011 |
4. C-Type（协处理器指令）
	| 31-26  |  25-21   | 20-16 | 15-11 | 10-6 |  5-0   |
	| :----: | :------: | :---: | :---: | :--: | :----: |
	| 0100xx | format:5 | ft:5  | fs:5  | fd:5 | Func:6 |
	- 基本参数说明
		+ fs，ft，fd是寄存器
		+ Func和format共同决定功能
		+ shamt是位移（shift amount）
	- 具体指令
		| 指令    | 参数       | Func   | Format |
		| ------- | ---------- | ------ | ------ |
		| add.s   | fd, fs, ft | 000000 | 10000  |
		| cvt.s.w | fd, fs, ft | 100000 | 10100  |
		| cvt.w.s | fd, fs, ft | 100100 | 10000  |
		| div.s   | fd, fs, ft | 000011 | 10000  |
		| mfc1    | ft, fs     | 000000 | 00000  |
		| mov.s   | fd, fs     | 000110 | 10000  |
		| mtc1    | ft, fs     | 000000 | 00100  |
		| mul.s   | fd, fs, ft | 000010 | 10000  |
		| sub.s   | fd, fs, ft | 000001 | 10000  |

RISC-V指令基本格式
* 长度为32位
* 低7位为操作码，其余为操作数

### 作业 反汇编（机器码转指令）
## 六、汇编器
### 内容
寄存器32\*32

寄存器约定具体用途：为了方便编程时数据的传送（如统一用a0、a1作返回值）

## 七、模拟器
### 内容
## 八、CPU设计
### $4.02 基本组件设计
门级设计

重要元件
1. 多路选择器
2. 译码器
3. 移位器
	- 移n位：建议组合
	- 符号扩展：重复最高位（对于补码）

问题：门有延时，为了保证每个组合逻辑元件都运行完，需要一个节拍

状态元件
* 类似：车站（早算完的等一会）

ALU Control
* 由于加减非常常用（不止算术运算指令需要），在ALU外再加一个ALU Control，由ALU op和指令低6位联合产生最终的控制码（3位）。这样只需要两位ALU op就可以加减。

Memory
* 指令存储器（只读）
* 数据存储器（读写）

寄存器组（Register File）
* 两路读，一路写（这样一个周期内就能同时读取两个数）

### $4.03 组件的功能组合
\#TODO 太困没听

### 4.15 课
slt：比较指令（小于）
* 可以用减法或比较器

在ALU里直接传出状态信息，而不用状态寄存器（记录zero，CF，OF等）：流水线难做

### 5.4 课
关于显存和内存是否分开
* \#TODO

用类似硬件的方式模拟
* 可以用于验证

模拟器：高级语言写
虚拟机：

### $4.09 流水线
问题：
* 当执行的指令是跳转的时候，下一条指令有可能不执行
	1. 等
	2. 猜
	3. 使用slot（槽）

## 大程一、运算器
### 模块实现
#### 移位
32位桶形移位寄存器：见数逻P545-546，图10-9。

## 期中考试
### 考试要求
考到4.20的课

有编程题

可以手写A4纸，彩色双面

### 考试答案和讲解
智云：计算机组成 2022-06-08第3-5节

## 附录一、硬件设计
### Vivado
器件（Parts）型号：
* Family:  Kintex7
* Device:  XC7K160T
* Package:  FFG676
* Speed:  -2L

### SWORD版
#### 7段数码管
##### MC14495
4位16进制数 -> 7+1数码管LED显示

